"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const lib_dynamodb_1 = require("@aws-sdk/lib-dynamodb");
const uuid_1 = require("uuid");
const auth_1 = require("../../shared/auth");
const validation_1 = require("../../shared/validation");
const client = new client_dynamodb_1.DynamoDBClient({});
const docClient = lib_dynamodb_1.DynamoDBDocumentClient.from(client);
const headers = {
    'Content-Type': 'application/json',
    'Access-Control-Allow-Origin': '*',
    'Access-Control-Allow-Methods': 'GET, POST, PUT, PATCH, DELETE, OPTIONS',
    'Access-Control-Allow-Headers': 'Content-Type, Authorization, If-Match',
};
const handler = async (event) => {
    try {
        if (event.httpMethod === 'OPTIONS') {
            return { statusCode: 200, headers, body: '' };
        }
        // Verify JWT token using shared utility
        const authResult = (0, auth_1.verifyToken)(event.headers.Authorization || event.headers.authorization);
        if (!authResult.success) {
            return {
                statusCode: 401,
                headers,
                body: JSON.stringify({ success: false, error: { message: 'Unauthorized' } }),
            };
        }
        const userId = authResult.userId;
        const method = event.httpMethod;
        const pathParameters = event.pathParameters;
        switch (method) {
            case 'GET':
                return await getDocuments(userId, event.queryStringParameters);
            case 'POST':
                return await createDocument(userId, JSON.parse(event.body || '{}'));
            case 'PUT':
                return await updateDocument(pathParameters?.id, JSON.parse(event.body || '{}'), userId);
            case 'PATCH':
                return await patchDocument(pathParameters?.id, JSON.parse(event.body || '{}'), userId);
            case 'DELETE':
                return await deleteDocument(pathParameters?.id, userId);
            default:
                return {
                    statusCode: 405,
                    headers,
                    body: JSON.stringify({ success: false, error: { message: 'Method not allowed' } }),
                };
        }
    }
    catch (error) {
        console.error('Error:', error);
        return {
            statusCode: 500,
            headers,
            body: JSON.stringify({ success: false, error: { message: 'Internal server error' } }),
        };
    }
};
exports.handler = handler;
async function getDocuments(userId, queryParams) {
    let keyConditionExpression = 'userId = :userId';
    const expressionAttributeValues = {
        ':userId': userId,
    };
    // Add type filter if provided
    if (queryParams?.type && (0, validation_1.validateDocumentType)(queryParams.type)) {
        keyConditionExpression += ' AND #type = :type';
        expressionAttributeValues[':type'] = queryParams.type;
    }
    const result = await docClient.send(new lib_dynamodb_1.QueryCommand({
        TableName: process.env.DOCUMENTS_TABLE_NAME,
        IndexName: 'userId-index',
        KeyConditionExpression: keyConditionExpression,
        ExpressionAttributeNames: queryParams?.type ? { '#type': 'type' } : undefined,
        ExpressionAttributeValues: expressionAttributeValues,
    }));
    return {
        statusCode: 200,
        headers,
        body: JSON.stringify({
            success: true,
            data: {
                documents: result.Items || [],
                total: result.Count || 0,
            },
        }),
    };
}
async function createDocument(userId, body) {
    const { type, title, content } = body;
    if (!type || !title) {
        return {
            statusCode: 400,
            headers,
            body: JSON.stringify({ success: false, error: { message: 'Missing required fields' } }),
        };
    }
    if (!(0, validation_1.validateDocumentType)(type)) {
        return {
            statusCode: 400,
            headers,
            body: JSON.stringify({ success: false, error: { message: 'Invalid document type' } }),
        };
    }
    const validation = (0, validation_1.validateDocumentData)(type, title, content);
    if (!validation.isValid) {
        return {
            statusCode: 400,
            headers,
            body: JSON.stringify({ success: false, error: { message: 'Validation failed', details: validation.errors } }),
        };
    }
    const documentId = (0, uuid_1.v4)();
    const now = new Date().toISOString();
    const document = {
        documentId,
        userId,
        type,
        title,
        content: content || '',
        version: 1,
        createdAt: now,
        updatedAt: now,
    };
    await docClient.send(new lib_dynamodb_1.PutCommand({
        TableName: process.env.DOCUMENTS_TABLE_NAME,
        Item: document,
    }));
    return {
        statusCode: 201,
        headers,
        body: JSON.stringify({
            success: true,
            data: document,
        }),
    };
}
async function updateDocument(documentId, body, userId) {
    const { title, content, type } = body;
    // Check document ownership
    const ownershipCheck = await verifyDocumentOwnership(documentId, userId);
    if (!ownershipCheck.success) {
        return ownershipCheck.response;
    }
    if (!title && !content) {
        return {
            statusCode: 400,
            headers,
            body: JSON.stringify({ success: false, error: { message: 'No fields to update' } }),
        };
    }
    // If type is provided, validate the document data
    if (type && title) {
        if (!(0, validation_1.validateDocumentType)(type)) {
            return {
                statusCode: 400,
                headers,
                body: JSON.stringify({ success: false, error: { message: 'Invalid document type' } }),
            };
        }
        const validation = (0, validation_1.validateDocumentData)(type, title, content);
        if (!validation.isValid) {
            return {
                statusCode: 400,
                headers,
                body: JSON.stringify({ success: false, error: { message: 'Validation failed', details: validation.errors } }),
            };
        }
    }
    const updateExpression = [];
    const expressionAttributeValues = {};
    if (title) {
        updateExpression.push('title = :title');
        expressionAttributeValues[':title'] = title;
    }
    if (content) {
        updateExpression.push('content = :content');
        expressionAttributeValues[':content'] = content;
    }
    updateExpression.push('updatedAt = :updatedAt', '#version = #version + :inc');
    expressionAttributeValues[':updatedAt'] = new Date().toISOString();
    expressionAttributeValues[':inc'] = 1;
    const result = await docClient.send(new lib_dynamodb_1.UpdateCommand({
        TableName: process.env.DOCUMENTS_TABLE_NAME,
        Key: { documentId },
        UpdateExpression: `SET ${updateExpression.join(', ')}`,
        ExpressionAttributeNames: { '#version': 'version' },
        ExpressionAttributeValues: expressionAttributeValues,
        ReturnValues: 'ALL_NEW',
    }));
    return {
        statusCode: 200,
        headers,
        body: JSON.stringify({
            success: true,
            data: result.Attributes,
        }),
    };
}
async function patchDocument(documentId, body, userId) {
    const { title, content, version: clientVersion } = body;
    if (!title && !content) {
        return {
            statusCode: 400,
            headers,
            body: JSON.stringify({ success: false, error: { message: 'No fields to update' } }),
        };
    }
    // Check document ownership
    const ownershipCheck = await verifyDocumentOwnership(documentId, userId);
    if (!ownershipCheck.success) {
        return ownershipCheck.response;
    }
    // Get current document for version check
    const currentDoc = await docClient.send(new lib_dynamodb_1.GetCommand({
        TableName: process.env.DOCUMENTS_TABLE_NAME,
        Key: { documentId },
    }));
    if (!currentDoc.Item) {
        return {
            statusCode: 404,
            headers,
            body: JSON.stringify({ success: false, error: { message: 'Document not found' } }),
        };
    }
    // Version conflict check for concurrent editing
    if (clientVersion && currentDoc.Item.version !== clientVersion) {
        return {
            statusCode: 409,
            headers,
            body: JSON.stringify({
                success: false,
                error: {
                    message: 'Document has been modified by another user',
                    currentVersion: currentDoc.Item.version,
                    conflictData: currentDoc.Item
                }
            }),
        };
    }
    const updateExpression = [];
    const expressionAttributeValues = {};
    if (title !== undefined) {
        updateExpression.push('title = :title');
        expressionAttributeValues[':title'] = title;
    }
    if (content !== undefined) {
        updateExpression.push('content = :content');
        expressionAttributeValues[':content'] = content;
    }
    updateExpression.push('updatedAt = :updatedAt', '#version = #version + :inc');
    expressionAttributeValues[':updatedAt'] = new Date().toISOString();
    expressionAttributeValues[':inc'] = 1;
    const result = await docClient.send(new lib_dynamodb_1.UpdateCommand({
        TableName: process.env.DOCUMENTS_TABLE_NAME,
        Key: { documentId },
        UpdateExpression: `SET ${updateExpression.join(', ')}`,
        ExpressionAttributeNames: { '#version': 'version' },
        ExpressionAttributeValues: expressionAttributeValues,
        ReturnValues: 'ALL_NEW',
    }));
    return {
        statusCode: 200,
        headers,
        body: JSON.stringify({
            success: true,
            data: result.Attributes,
        }),
    };
}
async function deleteDocument(documentId, userId) {
    // Check document ownership
    const ownershipCheck = await verifyDocumentOwnership(documentId, userId);
    if (!ownershipCheck.success) {
        return ownershipCheck.response;
    }
    await docClient.send(new lib_dynamodb_1.DeleteCommand({
        TableName: process.env.DOCUMENTS_TABLE_NAME,
        Key: { documentId },
    }));
    return {
        statusCode: 200,
        headers,
        body: JSON.stringify({
            success: true,
            message: 'Document deleted successfully',
        }),
    };
}
async function verifyDocumentOwnership(documentId, userId) {
    const document = await docClient.send(new lib_dynamodb_1.GetCommand({
        TableName: process.env.DOCUMENTS_TABLE_NAME,
        Key: { documentId },
    }));
    if (!document.Item) {
        return {
            success: false,
            response: {
                statusCode: 404,
                headers,
                body: JSON.stringify({ success: false, error: { message: 'Document not found' } }),
            }
        };
    }
    if (document.Item.userId !== userId) {
        return {
            success: false,
            response: {
                statusCode: 403,
                headers,
                body: JSON.stringify({ success: false, error: { message: 'Access denied: You can only modify your own documents' } }),
            }
        };
    }
    return { success: true, document: document.Item };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvZnVuY3Rpb25zL2RvY3VtZW50cy9pbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFDQSw4REFBMEQ7QUFDMUQsd0RBQW1JO0FBQ25JLCtCQUFvQztBQUNwQyw0Q0FBZ0Q7QUFDaEQsd0RBQXFGO0FBR3JGLE1BQU0sTUFBTSxHQUFHLElBQUksZ0NBQWMsQ0FBQyxFQUFFLENBQUMsQ0FBQztBQUN0QyxNQUFNLFNBQVMsR0FBRyxxQ0FBc0IsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7QUFFdEQsTUFBTSxPQUFPLEdBQUc7SUFDZCxjQUFjLEVBQUUsa0JBQWtCO0lBQ2xDLDZCQUE2QixFQUFFLEdBQUc7SUFDbEMsOEJBQThCLEVBQUUsd0NBQXdDO0lBQ3hFLDhCQUE4QixFQUFFLHVDQUF1QztDQUN4RSxDQUFDO0FBRUssTUFBTSxPQUFPLEdBQUcsS0FBSyxFQUFFLEtBQTJCLEVBQWtDLEVBQUU7SUFDM0YsSUFBSSxDQUFDO1FBQ0gsSUFBSSxLQUFLLENBQUMsVUFBVSxLQUFLLFNBQVMsRUFBRSxDQUFDO1lBQ25DLE9BQU8sRUFBRSxVQUFVLEVBQUUsR0FBRyxFQUFFLE9BQU8sRUFBRSxJQUFJLEVBQUUsRUFBRSxFQUFFLENBQUM7UUFDaEQsQ0FBQztRQUVELHdDQUF3QztRQUN4QyxNQUFNLFVBQVUsR0FBRyxJQUFBLGtCQUFXLEVBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxhQUFhLElBQUksS0FBSyxDQUFDLE9BQU8sQ0FBQyxhQUFhLENBQUMsQ0FBQztRQUMzRixJQUFJLENBQUMsVUFBVSxDQUFDLE9BQU8sRUFBRSxDQUFDO1lBQ3hCLE9BQU87Z0JBQ0wsVUFBVSxFQUFFLEdBQUc7Z0JBQ2YsT0FBTztnQkFDUCxJQUFJLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxFQUFFLE9BQU8sRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLEVBQUUsT0FB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S0FBSyxVQUFVLHVCQUF1QixDQUFDLFVBQWtCLEVBQUUsTUFBYztJQUN2RSxNQUFNLFFBQVEsR0FBRyxNQUFNLFNBQVMsQ0FBQyxJQUFJLENBQUMsSUFBSSx5QkFBVSxDQUFDO1FBQ25ELFNBQVMsRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLG9CQUFvQjtRQUMzQyxHQUFHLEVBQUUsRUFBRSxVQUFVLEVBQUU7S0FDcEIsQ0FBQyxDQUFDLENBQUM7SUFFSixJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksRUFBRSxDQUFDO1FBQ25CLE9BQU87WUFDTCxPQUFPLEVBQUUsS0FBSztZQUNkLFFBQVEsRUFBRTtnQkFDUixVQUFVLEVBQUUsR0FBRztnQkFDZixPQUFPO2dCQUNQLElBQUksRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLEVBQUUsT0FBTyxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsRUFBRSxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsRUFBRSxDQUFDO2FBQ25GO1NBQ0YsQ0FBQztJQUNKLENBQUM7SUFFRCxJQUFJLFFBQVEsQ0FBQyxJQUFJLENBQUMsTUFBTSxLQUFLLE1BQU0sRUFBRSxDQUFDO1FBQ3BDLE9BQU87WUFDTCxPQUFPLEVBQUUsS0FBSztZQUNkLFFBQVEsRUFBRTtnQkFDUixVQUFVLEVBQUUsR0FBRztnQkFDZixPQUFPO2dCQUNQLElBQUksRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLEVBQUUsT0FBTyxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsRUFBRSxPQUFPLEVBQUUsdURBQXVELEVBQUUsRUFBRSxDQUFDO2FBQ3RIO1NBQ0YsQ0FBQztJQUNKLENBQUM7SUFFRCxPQUFPLEVBQUUsT0FBTyxFQUFFLElBQUksRUFBRSxRQUFRLEVBQUUsUUFBUSxDQUFDLElBQUksRUFBRSxDQUFDO0FBQ3BELENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBUElHYXRld2F5UHJveHlFdmVudCwgQVBJR2F0ZXdheVByb3h5UmVzdWx0IH0gZnJvbSAnYXdzLWxhbWJkYSc7XG5pbXBvcnQgeyBEeW5hbW9EQkNsaWVudCB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1keW5hbW9kYic7XG5pbXBvcnQgeyBEeW5hbW9EQkRvY3VtZW50Q2xpZW50LCBQdXRDb21tYW5kLCBHZXRDb21tYW5kLCBRdWVyeUNvbW1hbmQsIFVwZGF0ZUNvbW1hbmQsIERlbGV0ZUNvbW1hbmQgfSBmcm9tICdAYXdzLXNkay9saWItZHluYW1vZGInO1xuaW1wb3J0IHsgdjQgYXMgdXVpZHY0IH0gZnJvbSAndXVpZCc7XG5pbXBvcnQgeyB2ZXJpZnlUb2tlbiB9IGZyb20gJy4uLy4uL3NoYXJlZC9hdXRoJztcbmltcG9ydCB7IHZhbGlkYXRlRG9jdW1lbnRUeXBlLCB2YWxpZGF0ZURvY3VtZW50RGF0YSB9IGZyb20gJy4uLy4uL3NoYXJlZC92YWxpZGF0aW9uJztcbmltcG9ydCB7IERvY3VtZW50VHlwZSB9IGZyb20gJy4uLy4uL3R5cGVzL2RvY3VtZW50JztcblxuY29uc3QgY2xpZW50ID0gbmV3IER5bmFtb0RCQ2xpZW50KHt9KTtcbmNvbnN0IGRvY0NsaWVudCA9IER5bmFtb0RCRG9jdW1lbnRDbGllbnQuZnJvbShjbGllbnQpO1xuXG5jb25zdCBoZWFkZXJzID0ge1xuICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nLFxuICAnQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luJzogJyonLFxuICAnQWNjZXNzLUNvbnRyb2wtQWxsb3ctTWV0aG9kcyc6ICdHRVQsIFBPU1QsIFBVVCwgUEFUQ0gsIERFTEVURSwgT1BUSU9OUycsXG4gICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1IZWFkZXJzJzogJ0NvbnRlbnQtVHlwZSwgQXV0aG9yaXphdGlvbiwgSWYtTWF0Y2gnLFxufTtcblxuZXhwb3J0IGNvbnN0IGhhbmRsZXIgPSBhc3luYyAoZXZlbnQ6IEFQSUdhdGV3YXlQcm94eUV2ZW50KTogUHJvbWlzZTxBUElHYXRld2F5UHJveHlSZXN1bHQ+ID0+IHtcbiAgdHJ5IHtcbiAgICBpZiAoZXZlbnQuaHR0cE1ldGhvZCA9PT0gJ09QVElPTlMnKSB7XG4gICAgICByZXR1cm4geyBzdGF0dXNDb2RlOiAyMDAsIGhlYWRlcnMsIGJvZHk6ICcnIH07XG4gICAgfVxuXG4gICAgLy8gVmVyaWZ5IEpXVCB0b2tlbiB1c2luZyBzaGFyZWQgdXRpbGl0eVxuICAgIGNvbnN0IGF1dGhSZXN1bHQgPSB2ZXJpZnlUb2tlbihldmVudC5oZWFkZXJzLkF1dGhvcml6YXRpb24gfHwgZXZlbnQuaGVhZGVycy5hdXRob3JpemF0aW9uKTtcbiAgICBpZiAoIWF1dGhSZXN1bHQuc3VjY2Vzcykge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgc3RhdHVzQ29kZTogNDAxLFxuICAgICAgICBoZWFkZXJzLFxuICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7IHN1Y2Nlc3M6IGZhbHNlLCBlcnJvcjogeyBtZXNzYWdlOiAnVW5hdXRob3JpemVkJyB9IH0pLFxuICAgICAgfTtcbiAgICB9XG5cbiAgICBjb25zdCB1c2VySWQgPSBhdXRoUmVzdWx0LnVzZXJJZCE7XG5cbiAgICBjb25zdCBtZXRob2QgPSBldmVudC5odHRwTWV0aG9kO1xuICAgIGNvbnN0IHBhdGhQYXJhbWV0ZXJzID0gZXZlbnQucGF0aFBhcmFtZXRlcnM7XG5cbiAgICBzd2l0Y2ggKG1ldGhvZCkge1xuICAgICAgY2FzZSAnR0VUJzpcbiAgICAgICAgcmV0dXJuIGF3YWl0IGdldERvY3VtZW50cyh1c2VySWQsIGV2ZW50LnF1ZXJ5U3RyaW5nUGFyYW1ldGVycyk7XG4gICAgICBjYXNlICdQT1NUJzpcbiAgICAgICAgcmV0dXJuIGF3YWl0IGNyZWF0ZURvY3VtZW50KHVzZXJJZCwgSlNPTi5wYXJzZShldmVudC5ib2R5IHx8ICd7fScpKTtcbiAgICAgIGNhc2UgJ1BVVCc6XG4gICAgICAgIHJldHVybiBhd2FpdCB1cGRhdGVEb2N1bWVudChwYXRoUGFyYW1ldGVycz8uaWQhLCBKU09OLnBhcnNlKGV2ZW50LmJvZHkgfHwgJ3t9JyksIHVzZXJJZCk7XG4gICAgICBjYXNlICdQQVRDSCc6XG4gICAgICAgIHJldHVybiBhd2FpdCBwYXRjaERvY3VtZW50KHBhdGhQYXJhbWV0ZXJzPy5pZCEsIEpTT04ucGFyc2UoZXZlbnQuYm9keSB8fCAne30nKSwgdXNlcklkKTtcbiAgICAgIGNhc2UgJ0RFTEVURSc6XG4gICAgICAgIHJldHVybiBhd2FpdCBkZWxldGVEb2N1bWVudChwYXRoUGFyYW1ldGVycz8uaWQhLCB1c2VySWQpO1xuICAgICAgZGVmYXVsdDpcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBzdGF0dXNDb2RlOiA0MDUsXG4gICAgICAgICAgaGVhZGVycyxcbiAgICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7IHN1Y2Nlc3M6IGZhbHNlLCBlcnJvcjogeyBtZXNzYWdlOiAnTWV0aG9kIG5vdCBhbGxvd2VkJyB9IH0pLFxuICAgICAgICB9O1xuICAgIH1cbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBjb25zb2xlLmVycm9yKCdFcnJvcjonLCBlcnJvcik7XG4gICAgcmV0dXJuIHtcbiAgICAgIHN0YXR1c0NvZGU6IDUwMCxcbiAgICAgIGhlYWRlcnMsXG4gICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7IHN1Y2Nlc3M6IGZhbHNlLCBlcnJvcjogeyBtZXNzYWdlOiAnSW50ZXJuYWwgc2VydmVyIGVycm9yJyB9IH0pLFxuICAgIH07XG4gIH1cbn07XG5cbmFzeW5jIGZ1bmN0aW9uIGdldERvY3VtZW50cyh1c2VySWQ6IHN0cmluZywgcXVlcnlQYXJhbXM/OiBhbnkpIHtcbiAgbGV0IGtleUNvbmRpdGlvbkV4cHJlc3Npb24gPSAndXNlcklkID0gOnVzZXJJZCc7XG4gIGNvbnN0IGV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXM6IGFueSA9IHtcbiAgICAnOnVzZXJJZCc6IHVzZXJJZCxcbiAgfTtcblxuICAvLyBBZGQgdHlwZSBmaWx0ZXIgaWYgcHJvdmlkZWRcbiAgaWYgKHF1ZXJ5UGFyYW1zPy50eXBlICYmIHZhbGlkYXRlRG9jdW1lbnRUeXBlKHF1ZXJ5UGFyYW1zLnR5cGUpKSB7XG4gICAga2V5Q29uZGl0aW9uRXhwcmVzc2lvbiArPSAnIEFORCAjdHlwZSA9IDp0eXBlJztcbiAgICBleHByZXNzaW9uQXR0cmlidXRlVmFsdWVzWyc6dHlwZSddID0gcXVlcnlQYXJhbXMudHlwZTtcbiAgfVxuXG4gIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGRvY0NsaWVudC5zZW5kKG5ldyBRdWVyeUNvbW1hbmQoe1xuICAgIFRhYmxlTmFtZTogcHJvY2Vzcy5lbnYuRE9DVU1FTlRTX1RBQkxFX05BTUUsXG4gICAgSW5kZXhOYW1lOiAndXNlcklkLWluZGV4JyxcbiAgICBLZXlDb25kaXRpb25FeHByZXNzaW9uOiBrZXlDb25kaXRpb25FeHByZXNzaW9uLFxuICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lczogcXVlcnlQYXJhbXM/LnR5cGUgPyB7ICcjdHlwZSc6ICd0eXBlJyB9IDogdW5kZWZpbmVkLFxuICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXM6IGV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXMsXG4gIH0pKTtcblxuICByZXR1cm4ge1xuICAgIHN0YXR1c0NvZGU6IDIwMCxcbiAgICBoZWFkZXJzLFxuICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICBkYXRhOiB7XG4gICAgICAgIGRvY3VtZW50czogcmVzdWx0Lkl0ZW1zIHx8IFtdLFxuICAgICAgICB0b3RhbDogcmVzdWx0LkNvdW50IHx8IDAsXG4gICAgICB9LFxuICAgIH0pLFxuICB9O1xufVxuXG5hc3luYyBmdW5jdGlvbiBjcmVhdGVEb2N1bWVudCh1c2VySWQ6IHN0cmluZywgYm9keTogYW55KSB7XG4gIGNvbnN0IHsgdHlwZSwgdGl0bGUsIGNvbnRlbnQgfSA9IGJvZHk7XG5cbiAgaWYgKCF0eXBlIHx8ICF0aXRsZSkge1xuICAgIHJldHVybiB7XG4gICAgICBzdGF0dXNDb2RlOiA0MDAsXG4gICAgICBoZWFkZXJzLFxuICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoeyBzdWNjZXNzOiBmYWxzZSwgZXJyb3I6IHsgbWVzc2FnZTogJ01pc3NpbmcgcmVxdWlyZWQgZmllbGRzJyB9IH0pLFxuICAgIH07XG4gIH1cblxuICBpZiAoIXZhbGlkYXRlRG9jdW1lbnRUeXBlKHR5cGUpKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHN0YXR1c0NvZGU6IDQwMCxcbiAgICAgIGhlYWRlcnMsXG4gICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7IHN1Y2Nlc3M6IGZhbHNlLCBlcnJvcjogeyBtZXNzYWdlOiAnSW52YWxpZCBkb2N1bWVudCB0eXBlJyB9IH0pLFxuICAgIH07XG4gIH1cblxuICBjb25zdCB2YWxpZGF0aW9uID0gdmFsaWRhdGVEb2N1bWVudERhdGEodHlwZSBhcyBEb2N1bWVudFR5cGUsIHRpdGxlLCBjb250ZW50KTtcbiAgaWYgKCF2YWxpZGF0aW9uLmlzVmFsaWQpIHtcbiAgICByZXR1cm4ge1xuICAgICAgc3RhdHVzQ29kZTogNDAwLFxuICAgICAgaGVhZGVycyxcbiAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHsgc3VjY2VzczogZmFsc2UsIGVycm9yOiB7IG1lc3NhZ2U6ICdWYWxpZGF0aW9uIGZhaWxlZCcsIGRldGFpbHM6IHZhbGlkYXRpb24uZXJyb3JzIH0gfSksXG4gICAgfTtcbiAgfVxuXG4gIGNvbnN0IGRvY3VtZW50SWQgPSB1dWlkdjQoKTtcbiAgY29uc3Qgbm93ID0gbmV3IERhdGUoKS50b0lTT1N0cmluZygpO1xuXG4gIGNvbnN0IGRvY3VtZW50ID0ge1xuICAgIGRvY3VtZW50SWQsXG4gICAgdXNlcklkLFxuICAgIHR5cGUsXG4gICAgdGl0bGUsXG4gICAgY29udGVudDogY29udGVudCB8fCAnJyxcbiAgICB2ZXJzaW9uOiAxLFxuICAgIGNyZWF0ZWRBdDogbm93LFxuICAgIHVwZGF0ZWRBdDogbm93LFxuICB9O1xuXG4gIGF3YWl0IGRvY0NsaWVudC5zZW5kKG5ldyBQdXRDb21tYW5kKHtcbiAgICBUYWJsZU5hbWU6IHByb2Nlc3MuZW52LkRPQ1VNRU5UU19UQUJMRV9OQU1FLFxuICAgIEl0ZW06IGRvY3VtZW50LFxuICB9KSk7XG5cbiAgcmV0dXJuIHtcbiAgICBzdGF0dXNDb2RlOiAyMDEsXG4gICAgaGVhZGVycyxcbiAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7XG4gICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgZGF0YTogZG9jdW1lbnQsXG4gICAgfSksXG4gIH07XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHVwZGF0ZURvY3VtZW50KGRvY3VtZW50SWQ6IHN0cmluZywgYm9keTogYW55LCB1c2VySWQ6IHN0cmluZykge1xuICBjb25zdCB7IHRpdGxlLCBjb250ZW50LCB0eXBlIH0gPSBib2R5O1xuXG4gIC8vIENoZWNrIGRvY3VtZW50IG93bmVyc2hpcFxuICBjb25zdCBvd25lcnNoaXBDaGVjayA9IGF3YWl0IHZlcmlmeURvY3VtZW50T3duZXJzaGlwKGRvY3VtZW50SWQsIHVzZXJJZCk7XG4gIGlmICghb3duZXJzaGlwQ2hlY2suc3VjY2Vzcykge1xuICAgIHJldHVybiBvd25lcnNoaXBDaGVjay5yZXNwb25zZTtcbiAgfVxuXG4gIGlmICghdGl0bGUgJiYgIWNvbnRlbnQpIHtcbiAgICByZXR1cm4ge1xuICAgICAgc3RhdHVzQ29kZTogNDAwLFxuICAgICAgaGVhZGVycyxcbiAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHsgc3VjY2VzczogZmFsc2UsIGVycm9yOiB7IG1lc3NhZ2U6ICdObyBmaWVsZHMgdG8gdXBkYXRlJyB9IH0pLFxuICAgIH07XG4gIH1cblxuICAvLyBJZiB0eXBlIGlzIHByb3ZpZGVkLCB2YWxpZGF0ZSB0aGUgZG9jdW1lbnQgZGF0YVxuICBpZiAodHlwZSAmJiB0aXRsZSkge1xuICAgIGlmICghdmFsaWRhdGVEb2N1bWVudFR5cGUodHlwZSkpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHN0YXR1c0NvZGU6IDQwMCxcbiAgICAgICAgaGVhZGVycyxcbiAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoeyBzdWNjZXNzOiBmYWxzZSwgZXJyb3I6IHsgbWVzc2FnZTogJ0ludmFsaWQgZG9jdW1lbnQgdHlwZScgfSB9KSxcbiAgICAgIH07XG4gICAgfVxuXG4gICAgY29uc3QgdmFsaWRhdGlvbiA9IHZhbGlkYXRlRG9jdW1lbnREYXRhKHR5cGUgYXMgRG9jdW1lbnRUeXBlLCB0aXRsZSwgY29udGVudCk7XG4gICAgaWYgKCF2YWxpZGF0aW9uLmlzVmFsaWQpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHN0YXR1c0NvZGU6IDQwMCxcbiAgICAgICAgaGVhZGVycyxcbiAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoeyBzdWNjZXNzOiBmYWxzZSwgZXJyb3I6IHsgbWVzc2FnZTogJ1ZhbGlkYXRpb24gZmFpbGVkJywgZGV0YWlsczogdmFsaWRhdGlvbi5lcnJvcnMgfSB9KSxcbiAgICAgIH07XG4gICAgfVxuICB9XG5cbiAgY29uc3QgdXBkYXRlRXhwcmVzc2lvbiA9IFtdO1xuICBjb25zdCBleHByZXNzaW9uQXR0cmlidXRlVmFsdWVzOiBhbnkgPSB7fTtcblxuICBpZiAodGl0bGUpIHtcbiAgICB1cGRhdGVFeHByZXNzaW9uLnB1c2goJ3RpdGxlID0gOnRpdGxlJyk7XG4gICAgZXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlc1snOnRpdGxlJ10gPSB0aXRsZTtcbiAgfVxuXG4gIGlmIChjb250ZW50KSB7XG4gICAgdXBkYXRlRXhwcmVzc2lvbi5wdXNoKCdjb250ZW50ID0gOmNvbnRlbnQnKTtcbiAgICBleHByZXNzaW9uQXR0cmlidXRlVmFsdWVzWyc6Y29udGVudCddID0gY29udGVudDtcbiAgfVxuXG4gIHVwZGF0ZUV4cHJlc3Npb24ucHVzaCgndXBkYXRlZEF0ID0gOnVwZGF0ZWRBdCcsICcjdmVyc2lvbiA9ICN2ZXJzaW9uICsgOmluYycpO1xuICBleHByZXNzaW9uQXR0cmlidXRlVmFsdWVzWyc6dXBkYXRlZEF0J10gPSBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCk7XG4gIGV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXNbJzppbmMnXSA9IDE7XG5cbiAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZG9jQ2xpZW50LnNlbmQobmV3IFVwZGF0ZUNvbW1hbmQoe1xuICAgIFRhYmxlTmFtZTogcHJvY2Vzcy5lbnYuRE9DVU1FTlRTX1RBQkxFX05BTUUsXG4gICAgS2V5OiB7IGRvY3VtZW50SWQgfSxcbiAgICBVcGRhdGVFeHByZXNzaW9uOiBgU0VUICR7dXBkYXRlRXhwcmVzc2lvbi5qb2luKCcsICcpfWAsXG4gICAgRXhwcmVzc2lvbkF0dHJpYnV0ZU5hbWVzOiB7ICcjdmVyc2lvbic6ICd2ZXJzaW9uJyB9LFxuICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXM6IGV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXMsXG4gICAgUmV0dXJuVmFsdWVzOiAnQUxMX05FVycsXG4gIH0pKTtcblxuICByZXR1cm4ge1xuICAgIHN0YXR1c0NvZGU6IDIwMCxcbiAgICBoZWFkZXJzLFxuICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICBkYXRhOiByZXN1bHQuQXR0cmlidXRlcyxcbiAgICB9KSxcbiAgfTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gcGF0Y2hEb2N1bWVudChkb2N1bWVudElkOiBzdHJpbmcsIGJvZHk6IGFueSwgdXNlcklkOiBzdHJpbmcpIHtcbiAgY29uc3QgeyB0aXRsZSwgY29udGVudCwgdmVyc2lvbjogY2xpZW50VmVyc2lvbiB9ID0gYm9keTtcblxuICBpZiAoIXRpdGxlICYmICFjb250ZW50KSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHN0YXR1c0NvZGU6IDQwMCxcbiAgICAgIGhlYWRlcnMsXG4gICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7IHN1Y2Nlc3M6IGZhbHNlLCBlcnJvcjogeyBtZXNzYWdlOiAnTm8gZmllbGRzIHRvIHVwZGF0ZScgfSB9KSxcbiAgICB9O1xuICB9XG5cbiAgLy8gQ2hlY2sgZG9jdW1lbnQgb3duZXJzaGlwXG4gIGNvbnN0IG93bmVyc2hpcENoZWNrID0gYXdhaXQgdmVyaWZ5RG9jdW1lbnRPd25lcnNoaXAoZG9jdW1lbnRJZCwgdXNlcklkKTtcbiAgaWYgKCFvd25lcnNoaXBDaGVjay5zdWNjZXNzKSB7XG4gICAgcmV0dXJuIG93bmVyc2hpcENoZWNrLnJlc3BvbnNlO1xuICB9XG5cbiAgLy8gR2V0IGN1cnJlbnQgZG9jdW1lbnQgZm9yIHZlcnNpb24gY2hlY2tcbiAgY29uc3QgY3VycmVudERvYyA9IGF3YWl0IGRvY0NsaWVudC5zZW5kKG5ldyBHZXRDb21tYW5kKHtcbiAgICBUYWJsZU5hbWU6IHByb2Nlc3MuZW52LkRPQ1VNRU5UU19UQUJMRV9OQU1FLFxuICAgIEtleTogeyBkb2N1bWVudElkIH0sXG4gIH0pKTtcblxuICBpZiAoIWN1cnJlbnREb2MuSXRlbSkge1xuICAgIHJldHVybiB7XG4gICAgICBzdGF0dXNDb2RlOiA0MDQsXG4gICAgICBoZWFkZXJzLFxuICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoeyBzdWNjZXNzOiBmYWxzZSwgZXJyb3I6IHsgbWVzc2FnZTogJ0RvY3VtZW50IG5vdCBmb3VuZCcgfSB9KSxcbiAgICB9O1xuICB9XG5cbiAgLy8gVmVyc2lvbiBjb25mbGljdCBjaGVjayBmb3IgY29uY3VycmVudCBlZGl0aW5nXG4gIGlmIChjbGllbnRWZXJzaW9uICYmIGN1cnJlbnREb2MuSXRlbS52ZXJzaW9uICE9PSBjbGllbnRWZXJzaW9uKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHN0YXR1c0NvZGU6IDQwOSxcbiAgICAgIGhlYWRlcnMsXG4gICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7IFxuICAgICAgICBzdWNjZXNzOiBmYWxzZSwgXG4gICAgICAgIGVycm9yOiB7IFxuICAgICAgICAgIG1lc3NhZ2U6ICdEb2N1bWVudCBoYXMgYmVlbiBtb2RpZmllZCBieSBhbm90aGVyIHVzZXInLFxuICAgICAgICAgIGN1cnJlbnRWZXJzaW9uOiBjdXJyZW50RG9jLkl0ZW0udmVyc2lvbixcbiAgICAgICAgICBjb25mbGljdERhdGE6IGN1cnJlbnREb2MuSXRlbVxuICAgICAgICB9XG4gICAgICB9KSxcbiAgICB9O1xuICB9XG5cbiAgY29uc3QgdXBkYXRlRXhwcmVzc2lvbiA9IFtdO1xuICBjb25zdCBleHByZXNzaW9uQXR0cmlidXRlVmFsdWVzOiBhbnkgPSB7fTtcblxuICBpZiAodGl0bGUgIT09IHVuZGVmaW5lZCkge1xuICAgIHVwZGF0ZUV4cHJlc3Npb24ucHVzaCgndGl0bGUgPSA6dGl0bGUnKTtcbiAgICBleHByZXNzaW9uQXR0cmlidXRlVmFsdWVzWyc6dGl0bGUnXSA9IHRpdGxlO1xuICB9XG5cbiAgaWYgKGNvbnRlbnQgIT09IHVuZGVmaW5lZCkge1xuICAgIHVwZGF0ZUV4cHJlc3Npb24ucHVzaCgnY29udGVudCA9IDpjb250ZW50Jyk7XG4gICAgZXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlc1snOmNvbnRlbnQnXSA9IGNvbnRlbnQ7XG4gIH1cblxuICB1cGRhdGVFeHByZXNzaW9uLnB1c2goJ3VwZGF0ZWRBdCA9IDp1cGRhdGVkQXQnLCAnI3ZlcnNpb24gPSAjdmVyc2lvbiArIDppbmMnKTtcbiAgZXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlc1snOnVwZGF0ZWRBdCddID0gbmV3IERhdGUoKS50b0lTT1N0cmluZygpO1xuICBleHByZXNzaW9uQXR0cmlidXRlVmFsdWVzWyc6aW5jJ10gPSAxO1xuXG4gIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGRvY0NsaWVudC5zZW5kKG5ldyBVcGRhdGVDb21tYW5kKHtcbiAgICBUYWJsZU5hbWU6IHByb2Nlc3MuZW52LkRPQ1VNRU5UU19UQUJMRV9OQU1FLFxuICAgIEtleTogeyBkb2N1bWVudElkIH0sXG4gICAgVXBkYXRlRXhwcmVzc2lvbjogYFNFVCAke3VwZGF0ZUV4cHJlc3Npb24uam9pbignLCAnKX1gLFxuICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lczogeyAnI3ZlcnNpb24nOiAndmVyc2lvbicgfSxcbiAgICBFeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzOiBleHByZXNzaW9uQXR0cmlidXRlVmFsdWVzLFxuICAgIFJldHVyblZhbHVlczogJ0FMTF9ORVcnLFxuICB9KSk7XG5cbiAgcmV0dXJuIHtcbiAgICBzdGF0dXNDb2RlOiAyMDAsXG4gICAgaGVhZGVycyxcbiAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7XG4gICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgZGF0YTogcmVzdWx0LkF0dHJpYnV0ZXMsXG4gICAgfSksXG4gIH07XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGRlbGV0ZURvY3VtZW50KGRvY3VtZW50SWQ6IHN0cmluZywgdXNlcklkOiBzdHJpbmcpIHtcbiAgLy8gQ2hlY2sgZG9jdW1lbnQgb3duZXJzaGlwXG4gIGNvbnN0IG93bmVyc2hpcENoZWNrID0gYXdhaXQgdmVyaWZ5RG9jdW1lbnRPd25lcnNoaXAoZG9jdW1lbnRJZCwgdXNlcklkKTtcbiAgaWYgKCFvd25lcnNoaXBDaGVjay5zdWNjZXNzKSB7XG4gICAgcmV0dXJuIG93bmVyc2hpcENoZWNrLnJlc3BvbnNlO1xuICB9XG5cbiAgYXdhaXQgZG9jQ2xpZW50LnNlbmQobmV3IERlbGV0ZUNvbW1hbmQoe1xuICAgIFRhYmxlTmFtZTogcHJvY2Vzcy5lbnYuRE9DVU1FTlRTX1RBQkxFX05BTUUsXG4gICAgS2V5OiB7IGRvY3VtZW50SWQgfSxcbiAgfSkpO1xuXG4gIHJldHVybiB7XG4gICAgc3RhdHVzQ29kZTogMjAwLFxuICAgIGhlYWRlcnMsXG4gICAgYm9keTogSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgIG1lc3NhZ2U6ICdEb2N1bWVudCBkZWxldGVkIHN1Y2Nlc3NmdWxseScsXG4gICAgfSksXG4gIH07XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHZlcmlmeURvY3VtZW50T3duZXJzaGlwKGRvY3VtZW50SWQ6IHN0cmluZywgdXNlcklkOiBzdHJpbmcpIHtcbiAgY29uc3QgZG9jdW1lbnQgPSBhd2FpdCBkb2NDbGllbnQuc2VuZChuZXcgR2V0Q29tbWFuZCh7XG4gICAgVGFibGVOYW1lOiBwcm9jZXNzLmVudi5ET0NVTUVOVFNfVEFCTEVfTkFNRSxcbiAgICBLZXk6IHsgZG9jdW1lbnRJZCB9LFxuICB9KSk7XG5cbiAgaWYgKCFkb2N1bWVudC5JdGVtKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgcmVzcG9uc2U6IHtcbiAgICAgICAgc3RhdHVzQ29kZTogNDA0LFxuICAgICAgICBoZWFkZXJzLFxuICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7IHN1Y2Nlc3M6IGZhbHNlLCBlcnJvcjogeyBtZXNzYWdlOiAnRG9jdW1lbnQgbm90IGZvdW5kJyB9IH0pLFxuICAgICAgfVxuICAgIH07XG4gIH1cblxuICBpZiAoZG9jdW1lbnQuSXRlbS51c2VySWQgIT09IHVzZXJJZCkge1xuICAgIHJldHVybiB7XG4gICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgIHJlc3BvbnNlOiB7XG4gICAgICAgIHN0YXR1c0NvZGU6IDQwMyxcbiAgICAgICAgaGVhZGVycyxcbiAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoeyBzdWNjZXNzOiBmYWxzZSwgZXJyb3I6IHsgbWVzc2FnZTogJ0FjY2VzcyBkZW5pZWQ6IFlvdSBjYW4gb25seSBtb2RpZnkgeW91ciBvd24gZG9jdW1lbnRzJyB9IH0pLFxuICAgICAgfVxuICAgIH07XG4gIH1cblxuICByZXR1cm4geyBzdWNjZXNzOiB0cnVlLCBkb2N1bWVudDogZG9jdW1lbnQuSXRlbSB9O1xufVxuXG4iXX0=